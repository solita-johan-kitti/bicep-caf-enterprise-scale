{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.613.9944",
      "templateHash": "15059121593855427537"
    }
  },
  "parameters": {
    "managementGroupId": {
      "type": "string",
      "metadata": {
        "description": "The management group to deploy (scope) to"
      }
    },
    "resourceGroupNameLogs": {
      "type": "string",
      "defaultValue": "rg-logs-shared",
      "metadata": {
        "description": "Resource goupe used for logs"
      }
    },
    "logAnalyticWorkspaceName": {
      "type": "string",
      "defaultValue": "la-logs-shared",
      "metadata": {
        "description": "The name of the log anaylytic workspace."
      }
    },
    "policySource": {
      "type": "string",
      "defaultValue": "https://github.com/solita-johan-kitti/bicep-caf-enterprise-scale",
      "metadata": {
        "description": ""
      }
    },
    "assignmentEnforcementMode": {
      "type": "string",
      "defaultValue": "Default",
      "metadata": {
        "description": ""
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Assignment Identity Location"
      },
      "allowedValues": [
        "westeurope",
        "northeurope"
      ]
    }
  },
  "functions": [],
  "variables": {
    "tags": {
      "owner": "Johan Kitti",
      "technical-owner": "Johan Kitti",
      "costcenter": "1234",
      "project-identifier": "M56879",
      "environment": "shared",
      "gdpr": "no",
      "sla-level": "1"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[parameters('resourceGroupNameLogs')]",
      "subscriptionId": "1b6348ed-c10a-42cf-9aa9-6b81e637c337",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceGroupName": {
            "value": "[parameters('resourceGroupNameLogs')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "4823171421183131984"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "westeurope"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "resourceGroupID": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[parameters('resourceGroupName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[parameters('logAnalyticWorkspaceName')]",
      "subscriptionId": "1b6348ed-c10a-42cf-9aa9-6b81e637c337",
      "resourceGroup": "[parameters('resourceGroupNameLogs')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('logAnalyticWorkspaceName')]"
          },
          "sku": {
            "value": "Free"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "16449898595661281239"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "The name of the workspace."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The geo-location where the resource lives"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Free",
              "metadata": {
                "description": "The name of the SKU"
              },
              "allowedValues": [
                "Free",
                "Standard",
                "Premium",
                "PerNode",
                "PerGB2018",
                "Standalone",
                "CapacityReservation"
              ]
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to set"
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2020-10-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]"
                }
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceID": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('1b6348ed-c10a-42cf-9aa9-6b81e637c337', 'Microsoft.Resources/deployments', parameters('resourceGroupNameLogs'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "definitions",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {},
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "5249803764116106743"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "deployDiagnosticsSettingsForACIToLogAnalytics",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "11543516675933199796"
                    }
                  },
                  "parameters": {
                    "policySource": {
                      "type": "string",
                      "defaultValue": "Bicep"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "guid": "6eb49361-4964-401a-b0bb-fa7f77b30baf",
                    "displayName": "Deploy Diagnostic Settings for Azure Container Instances to Log Analytics workspace (CloudBlox™)",
                    "description": "Deploys the diagnostic settings for Azure Container Instances to stream to a regional Log Analytics workspace when any Azure Container Instances which is missing these diagnostic settings is created or updated.",
                    "policyCategory": "CloudBlox™ - Monitoring (CaC)",
                    "version": "0.1.0",
                    "resourceType": "Microsoft.ContainerInstance/containerGroups"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/policyDefinitions",
                      "apiVersion": "2020-09-01",
                      "name": "[variables('guid')]",
                      "properties": {
                        "displayName": "[variables('displayName')]",
                        "policyType": "Custom",
                        "mode": "Indexed",
                        "description": "[variables('description')]",
                        "metadata": {
                          "version": "[variables('version')]",
                          "category": "[variables('policyCategory')]",
                          "source": "[parameters('policySource')]"
                        },
                        "parameters": {
                          "logAnalytics": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Log Analytics workspace",
                              "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                              "strongType": "omsWorkspace",
                              "assignPermissions": true
                            }
                          },
                          "effect": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Effect",
                              "description": "Enable or disable the execution of the policy"
                            },
                            "allowedValues": [
                              "DeployIfNotExists",
                              "Disabled"
                            ],
                            "defaultValue": "DeployIfNotExists"
                          },
                          "profileName": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Profile name",
                              "description": "The diagnostic settings profile name"
                            },
                            "defaultValue": "setbypolicy_logAnalytics"
                          },
                          "metricsEnabled": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Enable metrics",
                              "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                            },
                            "allowedValues": [
                              "True",
                              "False"
                            ],
                            "defaultValue": "False"
                          }
                        },
                        "policyRule": {
                          "if": {
                            "field": "type",
                            "equals": "[variables('resourceType')]"
                          },
                          "then": {
                            "effect": "[[parameters('effect')]",
                            "details": {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "name": "[[parameters('profileName')]",
                              "existenceCondition": {
                                "allOf": [
                                  {
                                    "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                                    "equals": "[[parameters('metricsEnabled')]"
                                  }
                                ]
                              },
                              "roleDefinitionIds": [
                                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                              ],
                              "deployment": {
                                "properties": {
                                  "mode": "incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                      "resourceName": {
                                        "type": "string"
                                      },
                                      "location": {
                                        "type": "string"
                                      },
                                      "logAnalytics": {
                                        "type": "string"
                                      },
                                      "metricsEnabled": {
                                        "type": "string"
                                      },
                                      "profileName": {
                                        "type": "string"
                                      }
                                    },
                                    "variables": {},
                                    "resources": [
                                      {
                                        "type": "[format('{0}/providers/diagnosticSettings', variables('resourceType'))]",
                                        "apiVersion": "2017-05-01-preview",
                                        "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                                        "location": "[[parameters('location')]",
                                        "dependsOn": [],
                                        "properties": {
                                          "workspaceId": "[[parameters('logAnalytics')]",
                                          "metrics": [
                                            {
                                              "category": "AllMetrics",
                                              "enabled": "[[parameters('metricsEnabled')]",
                                              "retentionPolicy": {
                                                "enabled": false,
                                                "days": 0
                                              },
                                              "timeGrain": null
                                            }
                                          ]
                                        }
                                      }
                                    ],
                                    "outputs": {}
                                  },
                                  "parameters": {
                                    "location": {
                                      "value": "[[field('location')]"
                                    },
                                    "resourceName": {
                                      "value": "[[field('name')]"
                                    },
                                    "logAnalytics": {
                                      "value": "[[parameters('logAnalytics')]"
                                    },
                                    "metricsEnabled": {
                                      "value": "[[parameters('metricsEnabled')]"
                                    },
                                    "profileName": {
                                      "value": "[[parameters('profileName')]"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "policyID": {
                      "type": "string",
                      "value": "[format('Microsoft.Authorization/policyDefinitions/{0}', variables('guid'))]"
                    },
                    "policyName": {
                      "type": "string",
                      "value": "[variables('guid')]"
                    },
                    "policyDisplayName": {
                      "type": "string",
                      "value": "[reference(format('Microsoft.Authorization/policyDefinitions/{0}', variables('guid'))).displayName]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "deployDiagnosticsSettingsForACRToLogAnalytics",
              "location": "[deployment().location]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.613.9944",
                      "templateHash": "9379920227448477334"
                    }
                  },
                  "parameters": {
                    "policySource": {
                      "type": "string",
                      "defaultValue": "Bicep"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "guid": "38cc0630-c239-41df-a8ee-ae4cb21bfbc3",
                    "displayName": "Deploy Diagnostic Settings for Azure Container Registry to Log Analytics workspace (CloudBlox™)",
                    "description": "Deploys the diagnostic settings for Azure Container Registry to stream to a regional Log Analytics workspace when any Azure Container Registry which is missing these diagnostic settings is created or updated.",
                    "policyCategory": "CloudBlox™ - Monitoring (CaC)",
                    "version": "0.1.0",
                    "resourceType": "Microsoft.ContainerRegistry/registries"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/policyDefinitions",
                      "apiVersion": "2020-09-01",
                      "name": "[variables('guid')]",
                      "properties": {
                        "displayName": "[variables('displayName')]",
                        "policyType": "Custom",
                        "mode": "Indexed",
                        "description": "[variables('description')]",
                        "metadata": {
                          "version": "[variables('version')]",
                          "category": "[variables('policyCategory')]",
                          "source": "[parameters('policySource')]"
                        },
                        "parameters": {
                          "logAnalytics": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Log Analytics workspace",
                              "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                              "strongType": "omsWorkspace",
                              "assignPermissions": true
                            }
                          },
                          "effect": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Effect",
                              "description": "Enable or disable the execution of the policy"
                            },
                            "allowedValues": [
                              "DeployIfNotExists",
                              "Disabled"
                            ],
                            "defaultValue": "DeployIfNotExists"
                          },
                          "profileName": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Profile name",
                              "description": "The diagnostic settings profile name"
                            },
                            "defaultValue": "setbypolicy_logAnalytics"
                          },
                          "metricsEnabled": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Enable metrics",
                              "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                            },
                            "allowedValues": [
                              "True",
                              "False"
                            ],
                            "defaultValue": "False"
                          },
                          "logsEnabled": {
                            "type": "String",
                            "metadata": {
                              "displayName": "Enable logs",
                              "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                            },
                            "allowedValues": [
                              "True",
                              "False"
                            ],
                            "defaultValue": "True"
                          }
                        },
                        "policyRule": {
                          "if": {
                            "field": "type",
                            "equals": "[variables('resourceType')]"
                          },
                          "then": {
                            "effect": "[[parameters('effect')]",
                            "details": {
                              "type": "Microsoft.Insights/diagnosticSettings",
                              "name": "[[parameters('profileName')]",
                              "existenceCondition": {
                                "allOf": [
                                  {
                                    "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                                    "equals": "[[parameters('metricsEnabled')]"
                                  },
                                  {
                                    "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                                    "equals": "[[parameters('logAnalytics')]"
                                  }
                                ]
                              },
                              "roleDefinitionIds": [
                                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                              ],
                              "deployment": {
                                "properties": {
                                  "mode": "incremental",
                                  "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                      "resourceName": {
                                        "type": "string"
                                      },
                                      "location": {
                                        "type": "string"
                                      },
                                      "logAnalytics": {
                                        "type": "string"
                                      },
                                      "metricsEnabled": {
                                        "type": "string"
                                      },
                                      "logsEnabled": {
                                        "type": "string"
                                      },
                                      "profileName": {
                                        "type": "string"
                                      }
                                    },
                                    "variables": {},
                                    "resources": [
                                      {
                                        "type": "[format('{0}/providers/diagnosticSettings', variables('resourceType'))]",
                                        "apiVersion": "2017-05-01-preview",
                                        "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                                        "location": "[[parameters('location')]",
                                        "dependsOn": [],
                                        "properties": {
                                          "workspaceId": "[[parameters('logAnalytics')]",
                                          "metrics": [
                                            {
                                              "category": "AllMetrics",
                                              "enabled": "[[parameters('metricsEnabled')]",
                                              "retentionPolicy": {
                                                "enabled": false,
                                                "days": 0
                                              },
                                              "timeGrain": null
                                            }
                                          ],
                                          "logs": [
                                            {
                                              "category": "ContainerRegistryLoginEvents",
                                              "enabled": "[[parameters('logsEnabled')]"
                                            },
                                            {
                                              "category": "ContainerRegistryRepositoryEvents",
                                              "enabled": "[[parameters('logsEnabled')]"
                                            }
                                          ]
                                        }
                                      }
                                    ],
                                    "outputs": {}
                                  },
                                  "parameters": {
                                    "location": {
                                      "value": "[[field('location')]"
                                    },
                                    "resourceName": {
                                      "value": "[[field('name')]"
                                    },
                                    "logAnalytics": {
                                      "value": "[[parameters('logAnalytics')]"
                                    },
                                    "metricsEnabled": {
                                      "value": "[[parameters('metricsEnabled')]"
                                    },
                                    "logsEnabled": {
                                      "value": "[[parameters('logsEnabled')]"
                                    },
                                    "profileName": {
                                      "value": "[[parameters('profileName')]"
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "policyID": {
                      "type": "string",
                      "value": "[format('Microsoft.Authorization/policyDefinitions/{0}', variables('guid'))]"
                    },
                    "policyName": {
                      "type": "string",
                      "value": "[variables('guid')]"
                    },
                    "policyDisplayName": {
                      "type": "string",
                      "value": "[reference(format('Microsoft.Authorization/policyDefinitions/{0}', variables('guid'))).displayName]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "deployDiagnosticsSettingsToLogAnalytics": {
              "type": "array",
              "value": [
                {
                  "id": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACIToLogAnalytics'), '2019-10-01').outputs.policyID.value]",
                  "name": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACIToLogAnalytics'), '2019-10-01').outputs.policyName.value]",
                  "policyDisplayName": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACIToLogAnalytics'), '2019-10-01').outputs.policyDisplayName.value]"
                },
                {
                  "id": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACRToLogAnalytics'), '2019-10-01').outputs.policyID.value]",
                  "name": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACRToLogAnalytics'), '2019-10-01').outputs.policyName.value]",
                  "policyDisplayName": "[reference(format('Microsoft.Resources/deployments/{0}', 'deployDiagnosticsSettingsForACRToLogAnalytics'), '2019-10-01').outputs.policyDisplayName.value]"
                }
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "monitoringCaCDiagSetLAGovernanceInitiativ",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policySource": {
            "value": "[parameters('policySource')]"
          },
          "managementGroupId": {
            "value": "[parameters('managementGroupId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "10901289763359772107"
            }
          },
          "parameters": {
            "policySource": {
              "type": "string"
            },
            "managementGroupId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policySetDefinitions",
              "apiVersion": "2020-09-01",
              "name": "monitoringCaCDiagSetLAGovernanceInitiative",
              "properties": {
                "displayName": "Diagnostic Settings to Log Analytics Monitoring Compliance As Code (CaC) Governance",
                "policyType": "Custom",
                "description": "The CloudBlox™ Governance Diagnostic Settings to Log Analytics Monitoring Compliance As Code (CaC) Governance Initiative",
                "metadata": {
                  "version": "0.1.0",
                  "category": "CloudBlox™ - Monitoring (CaC)",
                  "source": "[parameters('policySource')]"
                },
                "parameters": {
                  "logAnalytics": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Log Analytics workspace",
                      "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                      "strongType": "omsWorkspace",
                      "assignPermissions": true
                    }
                  },
                  "aciEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "aciMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "acrEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "acrMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "acrLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "activitylogsEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "activitylogsLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aksEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "aksAllMetrics": {
                    "type": "String",
                    "metadata": {
                      "displayName": "AllMetrics - Enabled",
                      "description": "Whether to stream AllMetrics logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-kube-apiserver": {
                    "type": "String",
                    "metadata": {
                      "displayName": "kube-apiserver - Enabled",
                      "description": "Whether to stream kube-apiserver logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-kube-audit": {
                    "type": "String",
                    "metadata": {
                      "displayName": "kube-audit - Enabled",
                      "description": "Whether to stream kube-audit logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-kube-controller-manager": {
                    "type": "String",
                    "metadata": {
                      "displayName": "kube-controller-manager - Enabled",
                      "description": "Whether to stream kube-controller-manager logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-kube-scheduler": {
                    "type": "String",
                    "metadata": {
                      "displayName": "kube-scheduler - Enabled",
                      "description": "Whether to stream kube-scheduler logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-cluster-autoscaler": {
                    "type": "String",
                    "metadata": {
                      "displayName": "cluster-autoscaler - Enabled",
                      "description": "Whether to stream cluster-autoscaler logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-kube-audit-admin": {
                    "type": "String",
                    "metadata": {
                      "displayName": "kube-audit-admin - Enabled",
                      "description": "Whether to stream kube-audit-admin logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "aks-guard": {
                    "type": "String",
                    "metadata": {
                      "displayName": "guard - Enabled",
                      "description": "Whether to stream guard logs to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "batchAccountEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "batchAccountMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "batchAccountLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "datalakeAnalyticsEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "datalakeAnalyticsMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "datalakeAnalyticsLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "datalakeStoreEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "datalakeStoreMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "datalakeStoreLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "eventHubEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "eventHubMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "eventHubLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "keyVaultEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "keyVaultMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "keyVaultLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "logicAppsWfEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "logicAppsWfMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "logicAppsWfLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "recoveryVaultTagName": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Exclusion Tag Name",
                      "description": "Name of the tag to use for excluding vaults from this policy. This should be used along with the Exclusion Tag Value parameter."
                    },
                    "defaultValue": ""
                  },
                  "recoveryVaultTagValue": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Exclusion Tag Value",
                      "description": "Value of the tag to use for excluding vaults from this policy. This should be used along with the Exclusion Tag Name parameter."
                    },
                    "defaultValue": ""
                  },
                  "searchServicesEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "searchServicesMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "searchServicesLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "serviceBusEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "serviceBusMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "serviceBusLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  },
                  "streamAnalyticsEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "DeployIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "DeployIfNotExists"
                  },
                  "streamAnalyticsMetricsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable metrics",
                      "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "False"
                  },
                  "streamAnalyticsLogsEnabled": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Enable logs",
                      "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                    },
                    "allowedValues": [
                      "True",
                      "False"
                    ],
                    "defaultValue": "True"
                  }
                },
                "policyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Azure Container Instances to Log Analytics workspace (CloudBlox™)",
                    "policyDefinitionId": "[format('/providers/Microsoft.Management/managementgroups/{0}/providers/Microsoft.Authorization/policyDefinitions/6eb49361-4964-401a-b0bb-fa7f77b30baf', parameters('managementGroupId'))]",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('aciEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('aciMetricsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Azure Container Registry to Log Analytics workspace (CloudBlox™)",
                    "policyDefinitionId": "[format('/providers/Microsoft.Management/managementgroups/{0}/providers/Microsoft.Authorization/policyDefinitions/38cc0630-c239-41df-a8ee-ae4cb21bfbc3', parameters('managementGroupId'))]",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('acrEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('acrMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('acrLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Configure Azure Activity logs to stream to specified Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2465583e-4e78-4c15-b6be-a36cbc7c8b0f",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('activitylogsEffect')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('activitylogsLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Azure Kubernetes Service to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/6c66c325-74c8-42fd-a286-a74b0e2939d8",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('aksEffect')]"
                      },
                      "AllMetrics": {
                        "value": "[[parameters('aksAllMetrics')]"
                      },
                      "kube-apiserver": {
                        "value": "[[parameters('aks-kube-apiserver')]"
                      },
                      "kube-audi": {
                        "value": "[[parameters('aks-kube-audi')]"
                      },
                      "kube-controller-manager": {
                        "value": "[[parameters('aks-kube-controller-manager')]"
                      },
                      "kube-scheduler": {
                        "value": "[[parameters('aks-kube-scheduler')]"
                      },
                      "cluster-autoscaler": {
                        "value": "[[parameters('aks-cluster-autoscaler')]"
                      },
                      "kube-audit-admin": {
                        "value": "[[parameters('aks-kube-audit-admin')]"
                      },
                      "guard": {
                        "value": "[[parameters('aks-guard')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Batch Account to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/c84e5349-db6d-4769-805e-e14037dab9b5",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('batchAccountEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('batchAccountMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('batchAccountLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Data Lake Analytics to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/d56a5a7c-72d7-42bc-8ceb-3baf4c0eae03",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('datalakeAnalyticsEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('datalakeAnalyticsMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('datalakeAnalyticsLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Data Lake Storage Gen1 to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/25763a0a-5783-4f14-969e-79d4933eb74b",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('datalakeStoreEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('datalakeStoreMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('datalakeStoreLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Event Hub to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1f6e93e8-6b31-41b1-83f6-36e449a42579",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('eventHubEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('eventHubMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('eventHubLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Key Vault to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bef3f64c-5290-43b7-85b0-9b254eef4c47",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('keyVaultEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('keyVaultMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('keyVaultLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Logic Apps to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b889a06c-ec72-4b03-910a-cb169ee18721",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('logicAppsWfEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('logicAppsWfMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('logicAppsWfLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Recovery Services Vault to Log Analytics workspace for resource specific categories.",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/c717fb0c-d118-4c43-ab3d-ece30ac81fb3",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "tagName": {
                        "value": "[[parameters('recoveryVaultTagName')]"
                      },
                      "tagValue": {
                        "value": "[[parameters('recoveryVaultTagValue')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Search Services to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/08ba64b8-738f-4918-9686-730d2ed79c7d",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('searchServicesEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('searchServicesMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('searchServicesLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Service Bus to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/04d53d87-841c-4f23-8a5b-21564380b55e",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('serviceBusEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('serviceBusMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('serviceBusLogsEnabled')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Stream Analytics to Log Analytics workspace",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/237e0f7e-b0e8-4ec4-ad46-8c12cb66d673",
                    "parameters": {
                      "logAnalytics": {
                        "value": "[[parameters('logAnalytics')]"
                      },
                      "effect": {
                        "value": "[[parameters('streamAnalyticsEffect')]"
                      },
                      "metricsEnabled": {
                        "value": "[[parameters('streamAnalyticsMetricsEnabled')]"
                      },
                      "logsEnabled": {
                        "value": "[[parameters('streamAnalyticsLogsEnabled')]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "initiativeID": {
              "type": "string",
              "value": "[format('{0}{1}', tenantResourceId('Microsoft.Management/managementGroups', parameters('managementGroupId')), tenantResourceId('Microsoft.Authorization/policySetDefinitions', 'monitoringCaCDiagSetLAGovernanceInitiative'))]"
            },
            "initiativeName": {
              "type": "string",
              "value": "monitoringCaCDiagSetLAGovernanceInitiative"
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'definitions')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "securityGovernanceInitiativ",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policySource": {
            "value": "[parameters('policySource')]"
          },
          "managementGroupId": {
            "value": "[parameters('managementGroupId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "14778477923959332643"
            }
          },
          "parameters": {
            "policySource": {
              "type": "string"
            },
            "managementGroupId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policySetDefinitions",
              "apiVersion": "2020-09-01",
              "name": "securityGovernanceInitiative",
              "properties": {
                "displayName": "Security Governance (CloudBlox™)",
                "policyType": "Custom",
                "description": "Contains common CloudBlox™ Security Governance policies",
                "metadata": {
                  "version": "0.1.0",
                  "category": "CloudBlox™ - Security (CaC)",
                  "source": "[parameters('policySource')]"
                },
                "parameters": {
                  "ascStdPricingEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "Audit",
                      "Disabled"
                    ],
                    "defaultValue": "Audit"
                  }
                },
                "policyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "Security Center standard pricing tier should be selected",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/a1181c5f-672a-477a-979a-7d58aa086233",
                    "parameters": {
                      "effect": {
                        "value": "[[parameters('ascStdPricingEffect')]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "initiativeID": {
              "type": "string",
              "value": "[format('{0}{1}', tenantResourceId('Microsoft.Management/managementGroups', parameters('managementGroupId')), tenantResourceId('Microsoft.Authorization/policySetDefinitions', 'securityGovernanceInitiative'))]"
            },
            "initiativeName": {
              "type": "string",
              "value": "securityGovernanceInitiative"
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'definitions')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "iamGovernanceInitiativ",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policySource": {
            "value": "[parameters('policySource')]"
          },
          "managementGroupId": {
            "value": "[parameters('managementGroupId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "1549628757635075963"
            }
          },
          "parameters": {
            "policySource": {
              "type": "string"
            },
            "managementGroupId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policySetDefinitions",
              "apiVersion": "2020-09-01",
              "name": "iamGovernanceInitiative",
              "properties": {
                "displayName": "IAM Governance (CloudBlox™)",
                "policyType": "Custom",
                "description": "Contains common CloudBlox™ IAM Governance policies",
                "metadata": {
                  "version": "0.1.0",
                  "category": "CloudBlox™ - Iam (CaC)",
                  "source": "[parameters('policySource')]"
                },
                "parameters": {
                  "removeDepracatedAccountEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "AuditIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "AuditIfNotExists"
                  },
                  "removeDepracatedOwnerAccountEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "AuditIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "AuditIfNotExists"
                  },
                  "customRBACRulesEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "Audit",
                      "Disabled"
                    ],
                    "defaultValue": "Audit"
                  },
                  "moreThen1OwnerSubscriptionEffect": {
                    "type": "String",
                    "metadata": {
                      "displayName": "Effect",
                      "description": "Enable or disable the execution of the policy"
                    },
                    "allowedValues": [
                      "AuditIfNotExists",
                      "Disabled"
                    ],
                    "defaultValue": "AuditIfNotExists"
                  }
                },
                "policyDefinitions": [
                  {
                    "policyDefinitionReferenceId": "Deprecated accounts should be removed from your subscription",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/6b1cbf55-e8b6-442f-ba4c-7246b6381474",
                    "parameters": {
                      "effect": {
                        "value": "[[parameters('removeDepracatedAccountEffect')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Deprecated accounts with owner permissions should be removed from your subscription",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ebb62a0c-3560-49e1-89ed-27e074e9f8ad",
                    "parameters": {
                      "effect": {
                        "value": "[[parameters('removeDepracatedOwnerAccountEffect')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "Audit usage of custom RBAC rules",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/a451c1ef-c6ca-483d-87ed-f49761e3ffb5",
                    "parameters": {
                      "effect": {
                        "value": "[[parameters('customRBACRulesEffect')]"
                      }
                    }
                  },
                  {
                    "policyDefinitionReferenceId": "There should be more than one owner assigned to your subscription",
                    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/09024ccc-0c5f-475e-9457-b7c0d9ed487b",
                    "parameters": {
                      "effect": {
                        "value": "[[parameters('moreThen1OwnerSubscriptionEffect')]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "initiativeID": {
              "type": "string",
              "value": "[format('{0}{1}', tenantResourceId('Microsoft.Management/managementGroups', parameters('managementGroupId')), tenantResourceId('Microsoft.Authorization/policySetDefinitions', 'iamGovernanceInitiative'))]"
            },
            "initiativeName": {
              "type": "string",
              "value": "iamGovernanceInitiative"
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'definitions')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "assignments",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managementGroupID": {
            "value": "[parameters('managementGroupId')]"
          },
          "logAnalyticsWorkspace": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', '1b6348ed-c10a-42cf-9aa9-6b81e637c337', parameters('resourceGroupNameLogs')), 'Microsoft.Resources/deployments', parameters('logAnalyticWorkspaceName')), '2019-10-01').outputs.logAnalyticsWorkspaceID.value]"
          },
          "policySource": {
            "value": "[parameters('policySource')]"
          },
          "assignmentIdentityLocation": {
            "value": "[parameters('location')]"
          },
          "assignmentEnforcementMode": {
            "value": "[parameters('assignmentEnforcementMode')]"
          },
          "monitoringCaCDiagSetLAGovernanceInitiativId": {
            "value": "[reference(format('Microsoft.Resources/deployments/{0}', 'monitoringCaCDiagSetLAGovernanceInitiativ'), '2019-10-01').outputs.initiativeID.value]"
          },
          "securityGovernanceInitiativId": {
            "value": "[reference(format('Microsoft.Resources/deployments/{0}', 'securityGovernanceInitiativ'), '2019-10-01').outputs.initiativeID.value]"
          },
          "iamGovernanceInitiativId": {
            "value": "[reference(format('Microsoft.Resources/deployments/{0}', 'iamGovernanceInitiativ'), '2019-10-01').outputs.initiativeID.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.613.9944",
              "templateHash": "8334667431095400584"
            }
          },
          "parameters": {
            "policySource": {
              "type": "string"
            },
            "assignmentIdentityLocation": {
              "type": "string"
            },
            "assignmentEnforcementMode": {
              "type": "string"
            },
            "monitoringCaCDiagSetLAGovernanceInitiativId": {
              "type": "string"
            },
            "securityGovernanceInitiativId": {
              "type": "string"
            },
            "iamGovernanceInitiativId": {
              "type": "string"
            },
            "managementGroupID": {
              "type": "string"
            },
            "logAnalyticsWorkspace": {
              "type": "string",
              "metadata": {
                "description": "The name of the log anaylytic workspace to send diagnostic logs to."
              }
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "diagSetToLaCaCGovernance",
              "location": "[parameters('assignmentIdentityLocation')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "Diagnostic Settings to Log Analytics Monitoring Compliance As Code (CaC) Governance (CloudBlox™)",
                "description": "The CloudBlox™ Governance Diagnostic Settings to Log Analytics Monitoring Compliance As Code (CaC) Governance Assignment",
                "enforcementMode": "[parameters('assignmentEnforcementMode')]",
                "metadata": {
                  "category": "CloudBlox™ - Monitoring (CaC)",
                  "version": "0.1.0",
                  "source": "[parameters('policySource')]"
                },
                "policyDefinitionId": "[parameters('monitoringCaCDiagSetLAGovernanceInitiativId')]",
                "parameters": {
                  "logAnalytics": {
                    "value": "[parameters('logAnalyticsWorkspace')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "securityGovernance",
              "location": "[parameters('assignmentIdentityLocation')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "Security Governance (CloudBlox™)",
                "description": "Assignment of the Security Governance initiative to management group (CloudBlox™).",
                "enforcementMode": "[parameters('assignmentEnforcementMode')]",
                "metadata": {
                  "category": "CloudBlox™ - Security (CaC)",
                  "version": "0.1.0",
                  "source": "[parameters('policySource')]"
                },
                "policyDefinitionId": "[parameters('securityGovernanceInitiativId')]"
              }
            },
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2020-09-01",
              "name": "iamGovernance",
              "location": "[parameters('assignmentIdentityLocation')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "IAM Governance (CloudBlox™)",
                "description": "Assignment of the IAM Governance initiative to management group (CloudBlox™).",
                "enforcementMode": "[parameters('assignmentEnforcementMode')]",
                "metadata": {
                  "category": "CloudBlox™ - IAM (CaC)",
                  "version": "0.1.0",
                  "source": "[parameters('policySource')]"
                },
                "policyDefinitionId": "[parameters('iamGovernanceInitiativId')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('diagSetToLaCaCGovernance', 'Microsoft.Authorization/policyAssignments', parameters('managementGroupID'))]",
              "properties": {
                "principalId": "[reference(format('Microsoft.Authorization/policyAssignments/{0}', 'diagSetToLaCaCGovernance'), '2020-09-01', 'full').identity.principalId]",
                "roleDefinitionId": "/providers/microsoft.authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
              },
              "dependsOn": [
                "[format('Microsoft.Authorization/policyAssignments/{0}', 'diagSetToLaCaCGovernance')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('securityGovernance', 'Microsoft.Authorization/policyAssignments', parameters('managementGroupID'))]",
              "properties": {
                "principalId": "[reference(format('Microsoft.Authorization/policyAssignments/{0}', 'securityGovernance'), '2020-09-01', 'full').identity.principalId]",
                "roleDefinitionId": "/providers/microsoft.authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
              },
              "dependsOn": [
                "[format('Microsoft.Authorization/policyAssignments/{0}', 'securityGovernance')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid('iamGovernance', 'Microsoft.Authorization/policyAssignments', parameters('managementGroupID'))]",
              "properties": {
                "principalId": "[reference(format('Microsoft.Authorization/policyAssignments/{0}', 'iamGovernance'), '2020-09-01', 'full').identity.principalId]",
                "roleDefinitionId": "/providers/microsoft.authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635"
              },
              "dependsOn": [
                "[format('Microsoft.Authorization/policyAssignments/{0}', 'iamGovernance')]"
              ]
            }
          ],
          "outputs": {
            "assignmentNames": {
              "type": "array",
              "value": [
                "diagSetToLaCaCGovernance"
              ]
            },
            "roleAssignmentIDs": {
              "type": "array",
              "value": [
                "[format('Microsoft.Authorization/policyAssignments/{0}', 'diagSetToLaCaCGovernance')]"
              ]
            },
            "assignmentIDs": {
              "type": "array",
              "value": [
                "[format('Microsoft.Authorization/policyAssignments/{0}', 'diagSetToLaCaCGovernance')]"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[format('Microsoft.Resources/deployments/{0}', 'iamGovernanceInitiativ')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', '1b6348ed-c10a-42cf-9aa9-6b81e637c337', parameters('resourceGroupNameLogs')), 'Microsoft.Resources/deployments', parameters('logAnalyticWorkspaceName'))]",
        "[format('Microsoft.Resources/deployments/{0}', 'monitoringCaCDiagSetLAGovernanceInitiativ')]",
        "[format('Microsoft.Resources/deployments/{0}', 'securityGovernanceInitiativ')]"
      ]
    }
  ],
  "outputs": {
    "resourceNamesForCleanup": {
      "type": "array",
      "value": [
        "[reference(format('Microsoft.Resources/deployments/{0}', 'definitions'), '2019-10-01').outputs.deployDiagnosticsSettingsToLogAnalytics.value]",
        "[reference(format('Microsoft.Resources/deployments/{0}', 'monitoringCaCDiagSetLAGovernanceInitiativ'), '2019-10-01').outputs.initiativeName.value]",
        "[reference(format('Microsoft.Resources/deployments/{0}', 'securityGovernanceInitiativ'), '2019-10-01').outputs.initiativeName.value]",
        "[reference(format('Microsoft.Resources/deployments/{0}', 'assignments'), '2019-10-01').outputs.assignmentNames.value]"
      ]
    }
  }
}